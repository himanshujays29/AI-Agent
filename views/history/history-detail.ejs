<% layout('/layout/layout') -%>
  <div class="max-w-6xl py-10 markdown-body responce-container">
    Â  <a Â  Â  href="/history" Â  Â  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-6 inline-block"
      Â  Â >â¬… Back to History</a Â >
    Â  <h1 class="text-3xl font-bold mb-4">
      <%= record.topic %>
    </h1>
    Â  <p class="text-sm text-gray-500 mb-6">
      Â  Â  Generated: <%= record.createdAt.toDateString() %><br>
        Model: <strong class="text-blue-600">
          <%= record.model %>
        </strong> <!-- Feature 3 -->
        Â  </p>

    Â  <div class="bg-white p-4 rounded-lg shadow mb-6">
      Â  Â  <h2 class="text-2xl font-semibold mb-2">ğŸ” Research</h2>
      Â  Â  <div class="prose"><%- marked.parse(record.research) %></div>
      Â  </div>

    Â  <div class="bg-white p-4 rounded-lg shadow mb-6">
      Â  Â  <h2 class="text-2xl font-semibold mb-2">ğŸ§  Summary</h2>
      Â  Â  <div class="prose"><%- marked.parse(record.summary) %></div>
      Â  </div>

    Â  <!-- Chat Tutor Section (Feature 1) -->
    Â  <div id="chatContainer" class="bg-gray-100 p-4 rounded-lg shadow mb-6">
      Â  Â  <h2 class="text-2xl font-semibold mb-4 text-green-700">ğŸ’¬ AI Study Tutor</h2>
      Â  Â  <div id="chatHistory"
        class="space-y-4 h-64 overflow-y-auto p-2 bg-white rounded-lg mb-4 border border-gray-300">
        <div class="flex justify-start">
          <div class="bg-green-200 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-xs">
            Hello! I'm your AI tutor for **<%= record.topic %>**. Ask me anything!
          </div>
        </div>
        Â  Â 
      </div>
      <div id="chatInputArea" class="flex">
        <input type="text" id="chatMessage" placeholder="Ask a follow-up question..."
          class="flex-grow border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
        <button id="sendChatBtn"
          class="bg-green-600 text-white px-4 py-2 rounded-r-lg hover:bg-green-700 transition duration-150 disabled:opacity-50">
          <i class="fas fa-paper-plane"></i> Send
        </button>
      </div>
      <div id="chatStatus" class="mt-2 text-sm text-gray-600"></div>
      Â 
    </div>
    Â  <!-- End Chat Tutor Section -->

    Â  <a Â  Â  id="generateQuizHistory" Â  Â 
      class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mt-4 inline-block" Â >
      Â  Â  ğŸ¯ Generate Quiz for this topic
      Â  </a>

    Â  <div Â  Â  id="quizBox" Â  Â  class="hidden markdown-body bg-white p-4 rounded-lg shadow mt-4" Â >
      <%- record.quiz ? marked.parse(record.quiz) : '' %>
    </div>
    <% if(record.quiz) { %>
      <script>document.getElementById('quizBox').classList.remove('hidden');</script>
      <% } %>

        Â  <a Â  Â  href="/api/pdf/<%= record._id %>" Â  Â 
          class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 inline-block" Â >
          Â  Â  ğŸ“„ Export as PDF
          Â  </a>
        Â  <br /><br />
        Â  <label>Select Model:</label>
        Â  <select id="regenModelSelect" class="model-dropdown">
          Â  Â  <option value="gemini-2.5-flash-lite" <%=record.model==='gemini-2.5-flash-lite' ? 'selected' : '' %>
            >Gemini-2.5-Flash-Lite (Best)</option>
          Â  Â  <option value="gemini-2.5-flash" <%=record.model==='gemini-2.5-flash' ? 'selected' : '' %>
            >Gemini-2.5-Flash</option>
          Â  </select>
        Â  <form Â  Â  action="/history/regenerate/<%= record._id %>" Â  Â  method="POST" Â  Â  style="margin-top: 20px" Â >
          Â  Â  <button Â  Â  Â  type="button" Â  Â  Â  class="regen-btn" Â  Â  Â  id="regen-btn" Â  Â  Â 
            onclick="regenerateNotes('<%= record._id %>')" Â  Â >
            Â  Â  Â  <i class="fa-solid fa-rotate-right"></i> Regenerate Notes
            Â  Â  </button>
          Â  </form>

        Â  <div id="regenLoader" style="display: none; margin-top: 15px">
          Â  Â  <i Â  Â  Â  class="fa-solid fa-spinner fa-spin" Â  Â  Â  style="font-size: 24px; color: #007bff" Â  Â ></i>
          Â  Â  <span id="regenLoaderText">Regeneratingâ€¦ please wait</span>
          Â  </div>

          <a href="/history/compare/<%= record._id %>" class="compare-btn">
  <i class="fa-solid fa-code-compare"></i> Compare Versions
</a>

        Â  <div style="margin-top: 30px">
          Â  Â  <form action="/history/delete/<%= record._id %>" method="POST">
            Â  Â  Â  <button class="delete-detail-btn">
              Â  Â  Â  Â  <i class="fas fa-trash"></i> Delete This History
              Â  Â  Â  </button>
            Â  Â  </form>
          Â  </div>
  </div>
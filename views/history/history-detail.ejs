<% layout('/layout/layout') -%>
<div class="max-w-6xl py-10 markdown-body responce-container">
  <a
    href="/history"
    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-6 inline-block"
    >‚¨Ö Back to History</a
  >

  <h1 class="text-3xl font-bold mb-4">
    <%= record.topic %>
  </h1>
  <p class="text-sm text-gray-500 mb-6">
    Generated: <%= record.createdAt.toDateString() %><br />
    Model:
    <strong class="text-blue-600"><%= record.model %></strong>
  </p>

  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-2xl font-semibold mb-2">üîç Research</h2>
    <div class="prose"><%- marked.parse(record.research) %></div>
  </div>

  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-2xl font-semibold mb-2">üß† Summary</h2>
    <div class="prose"><%- marked.parse(record.summary) %></div>
  </div>

  <!-- Chat Tutor -->

  <a
    id="generateQuizHistory"
    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mt-4 inline-block cursor-pointer"
  >
    üéØ Generate Quiz for this topic
  </a>

  <div
    id="quizBox"
    class="hidden markdown-body bg-white p-4 rounded-lg shadow mt-4"
  >
    <%- record.quiz ? marked.parse(record.quiz) : '' %>
  </div>
  <% if(record.quiz) { %>
  <script>
    document.getElementById("quizBox").classList.remove("hidden");
  </script>
  <% } %>

  <a
    id="generateFlashcardsHistory"
    class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 mt-4 inline-block cursor-pointer"
  >
    üìò Generate Flashcards
  </a>
  <div
    id="flashcardBox"
    class="hidden markdown-body bg-white p-4 rounded-lg shadow mt-4"
  >
    <%- record.flashcards ? marked.parse(record.flashcards) : '' %>
  </div>
  <% if(record.flashcards) { %>
  <script>
    document.getElementById("flashcardBox").classList.remove("hidden");
  </script>
  <% } %>

  <!-- Mind Map Section -->
  <!-- FIX: Removed the 'if (!record.diagram)' check so the button is always visible for regeneration -->
  <button 
    id="generateDiagramBtn" 
    onclick="generateDiagramHistory('<%= record._id %>')" 
    class="bg-orange-500 text-black px-4 py-2 rounded-lg hover:bg-orange-600 mt-4 inline-block"
  >
    <i class="fas fa-project-diagram"></i> <%= record.diagram ? 'Regenerate Mind Map' : 'Generate Mind Map' %>
  </button>
    
  <div
    id="diagramWrapper"
    class="hidden relative bg-white p-4 rounded-lg shadow mt-4"
  >
    <div class="absolute top-2 right-2 flex gap-2 z-20">
      <button id="zoomInBtn" class="mind-btn">+</button>
      <button id="zoomOutBtn" class="mind-btn">‚àí</button>
      <button id="resetZoomBtn" class="mind-btn">‚ü≥</button>
      <button id="fullScreenBtn" class="mind-btn">‚õ∂</button>
    </div>
    <div id="mindmapContainer" class="w-full h-72 overflow-hidden">
      <!-- Ensure 'mermaid' class is present -->
      <div id="mindmapDiagram" class="mermaid">
        <%= record.diagram || '' %>
      </div>
    </div>
  </div>
  <% if(record.diagram) { %>
  <script>
    document.getElementById("diagramWrapper").classList.remove("hidden");
  </script>
  <% } %>

  <!-- EXPORT BUTTONS -->
  <div class="mt-4 flex gap-2 flex-wrap">
    <a
      href="/api/pdf/<%= record._id %>"
      class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 inline-block"
    >
      <i class="fas fa-file-pdf"></i> Export as PDF
    </a>

    <a
      href="/api/md/<%= record._id %>"
      class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 inline-block"
    >
      <i class="fab fa-markdown"></i> Download Markdown
    </a>
  </div>

  <br /><br />
  <!-- ... existing regen section ... -->
  <label>Select Model:</label>
  <select id="regenModelSelect" class="model-dropdown">
    <option
      value="gemini-2.5-flash-lite"
      <%=record.model==='gemini-2.5-flash-lite' ? 'selected' : '' %>
    >
      Gemini-2.5-Flash-Lite (Best)
    </option>
    <option
      value="gemini-2.5-flash"
      <%=record.model==='gemini-2.5-flash' ? 'selected' : '' %>
    >
      Gemini-2.5-Flash
    </option>
  </select>

  <form
    action="/history/regenerate/<%= record._id %>"
    method="POST"
    style="margin-top: 20px"
  >
    <button
      type="button"
      class="regen-btn"
      id="regen-btn"
      onclick="regenerateNotes('<%= record._id %>')"
    >
      <i class="fa-solid fa-rotate-right"></i> Regenerate Notes
    </button>
  </form>

  <div id="regenLoader" style="display: none; margin-top: 15px">
    <i
      class="fa-solid fa-spinner fa-spin"
      style="font-size: 24px; color: #007bff"
    ></i>
    <span id="regenLoaderText">Regenerating‚Ä¶ please wait</span>
  </div>

  <a href="/history/compare/<%= record._id %>" class="compare-btn">
    <i class="fa-solid fa-code-compare"></i> Compare Versions
  </a>

  <div style="margin-top: 30px">
    <form action="/history/delete/<%= record._id %>" method="POST" onsubmit="return confirm('Are you sure?');">
      <button class="delete-detail-btn">
        <i class="fas fa-trash"></i> Delete This History
      </button>
    </form>
  </div>
   <div id="chatContainer" class="bg-gray-100 p-4 rounded-lg shadow mb-6 mt-6">
    <h2 class="text-2xl font-semibold mb-4 text-green-700">üí¨ AI Study Tutor</h2>
    <div
      id="chatHistory"
      class="space-y-4 h-64 overflow-y-auto p-2 bg-white rounded-lg mb-4 border border-gray-300"
    >
      <div class="flex justify-start">
        <div
          class="bg-green-200 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-xs"
        >
          Hello! I'm your AI tutor for <strong><%= record.topic %></strong>. Ask
          me anything!
        </div>
      </div>
    </div>
    <div id="chatInputArea" class="flex">
      <input
        type="text"
        id="chatMessage"
        placeholder="Ask a follow-up question..."
        class="flex-grow border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <button
        id="sendChatBtn"
        class="bg-green-600 text-white px-4 py-2 rounded-r-lg hover:bg-green-700 transition duration-150 disabled:opacity-50"
      >
        <i class="fas fa-paper-plane"></i> Send
      </button>
    </div>
    <div id="chatStatus" class="mt-2 text-sm text-gray-600"></div>
  </div>
</div>

<script>
  // Function to handle Mind Map Generation
  async function generateDiagramHistory(id) {
    const btn = document.getElementById("generateDiagramBtn");
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
      const res = await fetch(`/api/diagram/${id}`);
      const data = await res.json();
      if (data.success) {
         const diagramDiv = document.getElementById("mindmapDiagram");
         diagramDiv.textContent = data.diagram;
         // Reset mermaid attribute so it can re-render if needed
         diagramDiv.removeAttribute("data-processed"); 
         
         document.getElementById("diagramWrapper").classList.remove("hidden");
         
         // Trigger Mermaid Render
         if (window.mermaid) {
            window.mermaid.init(undefined, document.getElementById("mindmapDiagram"));
         }
         
         btn.innerHTML = '<i class="fas fa-project-diagram"></i> Regenerate Mind Map';
      } else {
         alert("Error generating diagram: " + data.error);
         btn.innerHTML = originalText;
      }
    } catch (e) {
      console.error(e);
      alert("Network Error");
      btn.innerHTML = originalText;
    } finally {
      btn.disabled = false;
    }
  }
</script>
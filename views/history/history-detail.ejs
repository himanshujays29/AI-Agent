<% layout('/layout/layout') -%>

<!-- Center Content Wrapper -->
<div class="content-wrapper pt-10 ">
  
  <div class="flex justify-between mb-6" style="flex-direction: column;  gap: 20px;">
     <h1 class="text-2xl font-bold"><%= record.topic %></h1>
     <div class="text-xs text-chatgpt-subtle">
        <%= record.createdAt.toDateString() %>
     </div>
  </div>

  <!-- Research -->
  <div class="plain-output-box">
    <h2 class="text-2xl font-semibold mt-2 mb-5 text-chatgpt-subtle uppercase tracking-wide text-xs">Research Notes</h2>
    <div class="prose markdown-body aiout"><%- marked.parse(record.research) %></div>
  </div>

  <!-- Summary -->
  <div class="plain-output-box ">
    <h2 class="text-2xl font-semibold mt-2 mb-5 text-chatgpt-subtle uppercase tracking-wide text-xs">Summary</h2>
    <div class="prose markdown-body aiout"><%- marked.parse(record.summary) %></div>
  </div>

  <!-- DYNAMIC CONTENT (Quiz, Flashcards, Mindmap) -->
  <!-- These appear above buttons -->

  <!-- Quiz Output -->
  <div id="quizBox" class="plain-output-box mt-6 <%= record.quiz ? '' : 'hidden' %>">
     <h2 class="text-2xl font-semibold mt-2 mb-5 text-chatgpt-subtle uppercase tracking-wide text-xs">Quiz</h2>
     <div class="prose markdown-body aiout"><%- record.quiz ? marked.parse(record.quiz) : '' %></div>
  </div>

  <!-- Flashcards Output -->
     <h2 class="text-2xl font-semibold mt-2 mb-5 text-chatgpt-subtle uppercase tracking-wide text-xs">Flashcards</h2>

  <div id="flashcardBox" class="plain-output-box mt-6 prose markdown-body aiout <%= record.flashcards ? '' : 'hidden' %>">
     <div class="prose markdown-body aiout"><%- record.flashcards ? marked.parse(record.flashcards) : '' %></div>
  </div>

  <!-- Diagram Output -->
  <div id="diagramWrapper" class="plain-output-box mt-6 relative <%= record.diagram ? '' : 'hidden' %>">
     <div class="absolute top-2 right-2 flex gap-2 z-10">
        <button id="zoomInBtn" class="mind-btn">+</button>
        <button id="zoomOutBtn" class=" mind-btn">-</button>
        <button id="resetZoomBtn" class="mind-btn">âŸ³</button>
        <button id="fullScreenBtn" class=" mind-btn">â›¶</button>
     </div>
     <div id="mindmapContainer" class="w-full h-80 overflow-hidden rounded border border-gray-200 bg-white p-4">
        <div id="mindmapDiagram" class="mermaid">
           <%= record.diagram || '' %>
        </div>
     </div>
  </div>

  <!-- ACTION BUTTONS ROW (Minimalist) -->
  <div class="action-buttons-row">
      <button id="generateQuizHistory" class="minimal-btn">
          <i class="fa-solid fa-bullseye"></i> 
          <%= record.quiz ? 'Regenerate Quiz' : 'Quiz' %>
      </button>

      <button id="generateFlashcardsHistory" class="minimal-btn">
          <i class="fa-regular fa-clone"></i> 
          <%= record.flashcards ? 'Regenerate Flashcards' : 'Flashcards' %>
      </button>

      <button id="generateDiagramBtn" onclick="generateDiagramHistory('<%= record._id %>')" class="minimal-btn">
          <i class="fa-solid fa-diagram-project"></i> 
          <%= record.diagram ? 'Regenerate Mind Map' : 'Mind Map' %>
      </button>

      <a href="/api/pdf/<%= record._id %>" class="minimal-btn expbtn">
          <i class="fa-regular fa-file-pdf"></i> PDF
      </a>

      <a href="/api/md/<%= record._id %>" class="minimal-btn expbtn">
          <i class="fa-brands fa-markdown"></i> Markdown
      </a>
       <a href="/history/compare/<%= record._id %>" class="minimal-btn expbtn">
    <i class="fa-solid fa-code-compare"></i> Compare Versions
  </a>
      
      <form action="/history/delete/<%= record._id %>" method="POST" onsubmit="return confirm('Delete this study record?');" style="display:inline;">
          <button class="minimal-btn debtn">
             <i class="fa-solid fa-trash"></i> Delete
          </button>
      </form>
  </div>

  
  

  <!-- CHAT TUTOR (At the bottom) -->
  <div id="chatContainer" class="p-4 rounded-lg shadow mb-20 mt-6">
    <h2 class="text-2xl font-semibold mb-4 text-green-700">ðŸ’¬ AI Study Tutor</h2>
    <!-- Replaced bg-white with card -->
    <div
      id="chatHistory"
      class="space-y-4 h-64 overflow-y-auto p-2 card mb-4"
    >
      <div class="flex justify-start">
        <!-- Removed text-gray-800 to allow CSS variable to work -->
        <div
          class="bg-green-200 p-3 rounded-xl rounded-bl-none max-w-xs"
        >
          Hello! I'm your AI tutor for <strong><%= record.topic %></strong>. Ask
          me anything!
        </div>
      </div>
    </div>
    <div id="chatStatus" class="mt-2 text-sm text-chatgpt-subtle"></div>
  </div>

</div>

<!-- FLOATING CHAT INPUT FOR TUTOR -->
<div class="input-area-container mb-4">
    <div class="input-box-wrapper">
        <div class="input-main-row">
            <input 
                id="chatMessage" 
                class="chat-input" 
                placeholder="Ask follow-up questions..." 
                autocomplete="off"
            />
            <button id="sendChatBtn" class="send-btn-float">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </div>
</div>

<script>
  // Setup Chat Logic for Detail Page
  const recordId = "<%= record._id %>";
  const sendBtn = document.getElementById("sendChatBtn");
  const input = document.getElementById("chatMessage");
  const historyDiv = document.getElementById("chatHistory");
  let chatHist = [];

  const appendMsg = (role, text) => {
      const div = document.createElement("div");
      div.className = role === "user" ? "flex justify-end" : "flex justify-start";
      const bubble = document.createElement("div");
      bubble.className = role === "user" 
         ? "bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none max-w-lg text-sm" 
         : "bg-green-200 p-3 rounded-xl rounded-bl-none max-w-xs";
      bubble.innerHTML = role === "model" ? marked.parse(text) : text;
      div.appendChild(bubble);
      historyDiv.appendChild(div);
      window.scrollTo(0, document.body.scrollHeight);
  };

  const send = async () => {
     const txt = input.value.trim();
     if(!txt) return;
     appendMsg("user", txt);
     chatHist.push({role: "user", text: txt});
     input.value = "";
     sendBtn.disabled = true;

     try {
        const res = await fetch(`/api/chat/${recordId}`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ userMessage: txt, chatHistory: chatHist })
        });
        const data = await res.json();
        if(data.success) {
            appendMsg("model", data.response);
            chatHist.push({role:"model", text: data.response});
        }
     } catch(e) { console.error(e); }
     sendBtn.disabled = false;
  };

  sendBtn.onclick = send;
  input.onkeypress = (e) => { if(e.key==="Enter") send(); }

  // Re-init mermaid if needed
  if(document.getElementById("mindmapDiagram")) {
      document.addEventListener("DOMContentLoaded", () => {
         if(window.mermaid) window.mermaid.init(undefined, document.getElementById("mindmapDiagram"));
         if(typeof initMindmapControls === 'function') initMindmapControls();
      });
  }

  // Diagram Generation Function
  async function generateDiagramHistory(id) {
    const btn = document.getElementById("generateDiagramBtn");
    const oldHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.disabled = true;
    try {
      const res = await fetch(`/api/diagram/${id}`);
      const data = await res.json();
      if(data.success) {
         const diag = document.getElementById("mindmapDiagram");
         diag.textContent = data.diagram;
         diag.removeAttribute("data-processed");
         document.getElementById("diagramWrapper").classList.remove("hidden");
         if(window.mermaid) window.mermaid.init(undefined, diag);
         if(typeof initMindmapControls === 'function') initMindmapControls();
         btn.innerHTML = '<i class="fa-solid fa-diagram-project"></i> Regenerate Mind Map';
      }
    } catch(e) { console.error(e); }
    btn.disabled = false;
  }
</script>
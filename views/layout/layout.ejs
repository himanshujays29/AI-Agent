<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Study Tutor</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown-light.css" />
    <link rel="stylesheet" href="/css/style.css" />

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({ startOnLoad: true });
    </script>

    <!-- Inject Firebase Config -->
    <script>
      window.FIREBASE_CONFIG = <%- JSON.stringify(firebaseConfig) %>;
    </script>
  </head>

  <body class="bg-chatgpt-body text-chatgpt-text">
    <div class="layout-root">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <!-- Header -->
        <div class="px-4 py-4 flex items-center justify-between border-b border-chatgpt-border">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-500 to-emerald-400 flex items-center justify-center text-white font-bold">
              AI
            </div>
            <div class="sidebar-label-text">
              <p class="text-sm font-semibold">Study Tutor</p>
              <p class="text-xs text-chatgpt-subtle">Multi-LLM Learning Agent</p>
            </div>
          </div>

          <button id="sidebarCollapseBtn" class="p-1 rounded-md hover:bg-chatgpt-soft text-xs" type="button">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
        </div>

        <!-- Main nav -->
        <nav class="px-3 mt-2 flex-1 overflow-y-auto">
          <a href="/" class="nav-item">
            <i class="fa-solid fa-plus mr-2"></i>
            <span class="sidebar-label-text">New Study Session</span>
          </a>

          <a href="/history" class="nav-item">
            <i class="fa-solid fa-clock-rotate-left mr-2"></i>
            <span class="sidebar-label-text">History</span>
          </a>

          <a href="#" class="nav-item" id="newChatBtnSidebar">
            <i class="fa-solid fa-comments mr-2"></i>
            <span class="sidebar-label-text">New Chat</span>
          </a>

          <!-- Your chats -->
          <div class="mt-4">
            <div class="sidebar-section-header">
              <div class="flex items-center gap-1">
                <span class="sidebar-section-title">Your chats</span>
              </div>
              <button id="toggleChatsBtn" class="section-toggle-btn" type="button">
                <i class="fa-solid fa-chevron-down"></i>
              </button>
            </div>
            <ul id="chatSessionList" class="sidebar-list open">
              <li class="p-2 text-xs text-chatgpt-subtle">Loading...</li>
            </ul>
          </div>

          <!-- Study history -->
          <div class="mt-4">
            <div class="sidebar-section-header">
              <span class="sidebar-section-title">Study history</span>
              <button id="toggleHistoryBtn" class="section-toggle-btn" type="button">
                <i class="fa-solid fa-chevron-down"></i>
              </button>
            </div>
            <ul id="historyList" class="sidebar-list open">
              <li class="p-2 text-xs text-chatgpt-subtle">Loading...</li>
            </ul>
          </div>
        </nav>

        <!-- Footer -->
        <div class="px-3 py-3 border-t border-chatgpt-border text-xs sidebar-footer">
          <% if (currentUser) { %>
            <div class="mb-2 text-chatgpt-subtle sidebar-label-text">
              Logged in as <span class="font-semibold"><%= currentUser.username %></span>
            </div>
            <a href="/auth/logout" class="nav-item">
              <i class="fa-solid fa-right-from-bracket mr-2"></i>
              <span class="sidebar-label-text">Logout</span>
            </a>
          <% } else { %>
            <a href="/auth/login" class="nav-item">
              <i class="fa-solid fa-right-to-bracket mr-2"></i>
              <span class="sidebar-label-text">Login</span>
            </a>
          <% } %>

          <button id="themeToggle" class="w-full flex items-center justify-between px-3 py-2 rounded-md text-xs bg-chatgpt-soft hover:bg-chatgpt-soft-hover transition mt-2" type="button">
            <span class="sidebar-label-text">
              <i class="fa-solid fa-moon mr-1"></i> Dark mode
            </span>
            <span class="text-[10px] text-chatgpt-subtle">Toggle</span>
          </button>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="main-content">
        <!-- Mobile Header -->
        <header class="md:hidden flex items-center justify-between px-4 py-3 border-b border-chatgpt-border bg-chatgpt-sidebar">
          <div class="flex items-center gap-2">
             <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-500 to-emerald-400 flex items-center justify-center text-white font-bold">AI</div>
             <span class="text-sm font-semibold">Study Tutor</span>
          </div>
          <button id="mobileSidebarToggle" class="p-2 rounded-md hover:bg-chatgpt-soft">
            <i class="fa-solid fa-bars"></i>
          </button>
        </header>

        <main class="flex-1 overflow-y-auto">
          <div class="mx-auto max-w-5xl px-4 py-6 md:px-8 md:py-8">
            <%- body -%>
          </div>
        </main>
      </div>
    </div>
    
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
      try {
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
        window.mermaid = mermaid;
      } catch(e) { console.log("Mermaid init skipped"); }
    </script>
    <script src="/js/main.js"></script>
    <script src="/js/script.js"></script>

    <script>
      // 1. Dark / light mode
      const themeToggle = document.getElementById("themeToggle");
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          const mode = document.body.classList.contains("dark") ? "dark" : "light";
          localStorage.setItem("ai-theme", mode);
        });
        if (localStorage.getItem("ai-theme") === "dark") document.body.classList.add("dark");
      }

      // 2. Sidebar collapse (desktop)
      const sidebar = document.getElementById("sidebar");
      const sidebarCollapseBtn = document.getElementById("sidebarCollapseBtn");
      
      if (sidebarCollapseBtn && sidebar) {
        sidebarCollapseBtn.addEventListener("click", () => {
          document.body.classList.toggle("sidebar-collapsed");
          sidebar.classList.toggle("collapsed");
          
          const icon = sidebarCollapseBtn.querySelector("i");
          if(icon) {
            icon.classList.toggle("fa-chevron-left");
            icon.classList.toggle("fa-chevron-right");
          }
          localStorage.setItem("ai-sidebar", sidebar.classList.contains("collapsed") ? "collapsed" : "open");
        });

        // Init state
        if (localStorage.getItem("ai-sidebar") === "collapsed") {
          document.body.classList.add("sidebar-collapsed");
          sidebar.classList.add("collapsed");
          const icon = sidebarCollapseBtn.querySelector("i");
          if(icon) {
            icon.classList.remove("fa-chevron-left");
            icon.classList.add("fa-chevron-right");
          }
        }
      }

      // 3. Mobile sidebar toggle
      const mobileSidebarToggle = document.getElementById("mobileSidebarToggle");
      if (mobileSidebarToggle && sidebar) {
        mobileSidebarToggle.addEventListener("click", () => {
          sidebar.classList.toggle("mobile-open");
        });
      }
      
      // 4. Collapse sections
      function setupToggle(btnId, listId) {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener("click", () => {
            const list = document.getElementById(listId);
            if (list) list.classList.toggle("open");
            const icon = btn.querySelector("i");
            if(icon) icon.classList.toggle("rotated");
          });
        }
      }
      setupToggle("toggleChatsBtn", "chatSessionList");
      setupToggle("toggleHistoryBtn", "historyList");

      // 5. Load sidebar data (Async)
      async function loadSidebarData() {
        // SAFE CHECK: Only fetch if user is logged in
        <% if (!currentUser) { %>
           // User not logged in, update UI to show empty/login state
           const chatList = document.getElementById("chatSessionList");
           if(chatList) chatList.innerHTML = "<li class='p-2 text-xs text-chatgpt-subtle'>Login to see chats</li>";
           
           const histList = document.getElementById("historyList");
           if(histList) histList.innerHTML = "<li class='p-2 text-xs text-chatgpt-subtle'>Login to see history</li>";
           return; 
        <% } %>

        try {
          const chatList = document.getElementById("chatSessionList");
          const histList = document.getElementById("historyList");

          // Load Chats
          const chatRes = await fetch("/chat/list");
          if (chatRes.ok) {
            const chatData = await chatRes.json();
            if(chatList) {
               chatList.innerHTML = "";
               if (!chatData.sessions || chatData.sessions.length === 0) {
                 chatList.innerHTML = "<li class='p-2 text-xs text-chatgpt-subtle'>No chats yet</li>";
               } else {
                 chatData.sessions.forEach((c) => {
                   const li = document.createElement("li");
                   li.innerHTML = `<a href="/chat/${c._id}" class="sidebar-link"><i class="fa-regular fa-message mr-1"></i><span class="sidebar-label-text">${c.title}</span></a>`;
                   chatList.appendChild(li);
                 });
               }
            }
          }

          // Load History
          const histRes = await fetch("/api/history-list");
          if (histRes.ok) {
            const histData = await histRes.json();
            if(histList) {
              histList.innerHTML = "";
              if (!histData.items || histData.items.length === 0) {
                histList.innerHTML = "<li class='p-2 text-xs text-chatgpt-subtle'>No history yet</li>";
              } else {
                histData.items.forEach((h) => {
                  const li = document.createElement("li");
                  li.innerHTML = `<a href="/history/${h._id}" class="sidebar-link"><i class="fa-regular fa-note-sticky mr-1"></i><span class="sidebar-label-text">${h.topic}</span></a>`;
                  histList.appendChild(li);
                });
              }
            }
          }
        } catch (err) {
          console.error("Sidebar load error:", err);
        }
      }
      
      // Run it
      loadSidebarData();
      
      // 6. New Chat Button
      const newChatBtn = document.getElementById("newChatBtnSidebar");
      if (newChatBtn) {
        newChatBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            const res = await fetch("/chat/new", { method: "POST" });
            const data = await res.json();
            if (data.success) window.location.href = "/chat/" + data.sessionId;
          } catch (err) {
            console.error("New chat error:", err);
          }
        });
      }
    </script>
  </body>
</html>